name: Deploy to Staging

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  deploy-staging:
    name: Deploy to Railway Staging
    runs-on: ubuntu-latest
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    outputs:
      staging-url: ${{ steps.deploy-staging.outputs.url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy Frontend to Staging
        id: deploy-staging
        run: |
          cd shader-playground
          echo "Checking environment variables..."
          echo "RAILWAY_TOKEN is set: $([ -n "$RAILWAY_TOKEN" ] && echo 'YES' || echo 'NO')"
          echo "RAILWAY_TOKEN length: ${#RAILWAY_TOKEN}"
          echo "Explicitly exporting RAILWAY_TOKEN..."
          export RAILWAY_TOKEN="$RAILWAY_TOKEN"
          echo "Attempting deployment with project token..."
          railway up --service frontend-staging --detach
          echo "url=https://frontend-staging-production-3876.up.railway.app" >> $GITHUB_OUTPUT

      - name: Deploy Backend to Staging
        run: |
          cd backend
          echo "Attempting backend deployment with project token..."
          export RAILWAY_TOKEN="$RAILWAY_TOKEN"
          railway up --service backend-staging --detach

  create-approval-issue:
    name: Create Production Approval Issue
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: always() && needs.deploy-staging.result == 'success'
    steps:
      - name: Create Production Approval Issue
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Production Deployment Approval Required - ' + context.sha.substring(0, 7),
              body: '## Production Deployment Request\n\n' +
                    '**Commit**: `' + context.sha + '`\n' +
                    '**Staging URL**: https://frontend-staging-production-3876.up.railway.app\n\n' +
                    '### Review Checklist\n' +
                    '- [ ] Staging environment tested and working\n' +
                    '- [ ] No breaking changes detected\n' +
                    '- [ ] Ready for production deployment\n\n' +
                    '### Approval Instructions\n' +
                    '**To approve**: Comment `approved` on this issue\n\n' +
                    '@lukashondrich',
              assignees: ['lukashondrich'],
              labels: ['deployment', 'production-approval']
            })
            console.log('Production approval issue created:', issue.number)